<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link rel="stylesheet" type="text/css" href="/css/AdminLTE.min.css">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <style type="text/css">
        html,body{
            height: 100%; 
        }
        .matrix{
            border: 1px solid #d2d6de;
            min-height: 100%;
        }
        .matrix>table{
            width:100%;
        }
        .head{
            width:100%;
        }
        .th_first{
            width:12%;
            border: 5px solid transparent;
            font-family:'Source Sans Pro','Helvetica Neue',Helvetica,Arial,sans-serif;
            text-align: center;
            font-weight: 400;
        }
        .th_not_first{
            border: 5px solid transparent;
            font-family:'Source Sans Pro','Helvetica Neue',Helvetica,Arial,sans-serif;
            font-weight: 400;
            width:2.9333%;
            text-align: center;
        }
        .myth p{
            /*transform: rotate(-20deg)*/
        }
        .td_first,.td_not_first{
            border: 1px solid transparent;
        }
    </style>
</head>
<body>
<!-- <div class="main">
    <table class="test">
        
    </table>
</div> -->
<div class="matrix">
    <table>
            <thead class="head">
                <tr>
                    <th class="th_first"><p>win-lost matrix</p></th>
                </tr>
            </thead>
            <tbody>
                
            </tbody>
    </table>
</div>
<script type="text/javascript" src="/lib/d3.js"></script>
<script type="text/javascript" src="/lib/jQuery.min.js"></script>
<script type="text/javascript">
    var team_mapping={
        'Atlanta Hawks':'ATL',
        'Boston Celtics':'BOS',
        'Brooklyn Nets':'BRK',
        'Charlotte Hornets':'CHA',
        'Chicago Bulls':'CHI',
        'Cleveland Cavaliers':'CLE',
        'Dallas Mavericks':'DAL',
        'Denver Nuggets':'DEN',
        'Detroit Pistons':'DET',
        'Golden State Warriors':'GSW',
        'Houston Rockets':'HOU',
        'Indiana Pacers':'IND',
        'Los Angeles Clippers':'LAC',
        'Los Angeles Lakers':'LAL',
        'Memphis Grizzlies':'MEM',
        'Miami Heat':'MIA',
        'Milwaukee Bucks':'MIL',
        'Minnesota Timberwolves':'MIN',
        'New Orleans Pelicans':'NOP',
        'New York Knicks':'NYK',
        'Oklahoma City Thunder':'OKC',
        'Orlando Magic':'ORL',
        'Philadelphia 76ers':'PHI',
        'Phoenix Suns':'PHO',
        'Portland Trail Blazers':'POR',
        'Sacramento Kings':'SAC',
        'San Antonio Spurs':'SAS',
        'Toronto Raptors':'TOR',
        'Utah Jazz':'UTA',
        'Washington Wizards':'WAS'
    }
    var teams=[];
    d3.csv('/data/winLostMatrix_2015.csv',function (error,data) {
        var tr_data=data;
        var th_data=[];
        tr_data[29].WAS="";//特殊情况人工处理
        // 数据重构
        for(let i=0;i<tr_data.length;i++){
            tr_data[i].tdData=[];
            tr_data[i].totalWin=0;
            tr_data[i].totalLost=0;
            for(let property in tr_data[i]){
                let temp=tr_data[i];

                if(!temp[property]){
                    if(i==0)teams.push(property);
                    temp.state=property;
                    temp[property]={
                        'win':0,
                        'lost':0,
                        'state':property,
                    }
                    temp.tdData.push(temp[property])
                }
                else if(property=='Team'){
                    temp.Name=temp[property].split(' ')[2]?temp[property].split(' ')[2]:temp[property].split(' ')[1];
                }
                else if(property=='Rk'){}
                else if(property!='tdData'&&property!='totalWin'&&property!='totalLost'&&property!='Name'&&property!='state'){
                    if(i==0)teams.push(property);
                    let win=temp[property].split('-')[0];
                    let lost=temp[property].split('-')[1];
                    temp[property]={
                        'win':win,
                        'lost':lost,
                        'state':property,
                    }
                    temp.totalWin+=Number(win);
                    temp.totalLost+=Number(lost);
                    temp.tdData.push(temp[property])//用于绑定列数据的数组
                }
            }
            th_data.push({
                'totalWin':tr_data[i].totalWin,
                'totalLost':tr_data[i].totalLost,
                'state':tr_data[i].state
            });
        }
        console.log(tr_data)
        console.log(th_data)
        d3.csv('/data/gameScoreList_2015.csv',function (error,raw_data) {
            var filtered_data=[];
            // 所有比赛数据重构 在制作第二张图表时会用到
            // 计算分差时是主队在前，客队在后
            for(let i=0;i<raw_data.length;i++){
                let temp={};
                let raw=raw_data[i];
                temp.diff=raw.HPTS-raw.VPTS;
                temp.home=team_mapping[raw.Home];
                temp.visitor=team_mapping[raw.Visitor];
                filtered_data.push(temp);
            }
            // 每个队伍的比赛数据筛选
            // 按照字母顺序存储
            var team_data=[];
            for(let i=0;i<30;i++){
                team_data[i]=[];
                for(let j=0;j<filtered_data.length;j++){
                    if(filtered_data[j].home==teams[i]||filtered_data[j].visitor==teams[i]){
                        team_data[i].push(filtered_data[j]);
                    }
                }
            }
            console.log(team_data)
            // 遍历tr_data[tdData[team_data]]
            for(let i=0;i<tr_data.length;i++){
                for(let j=0;j<tr_data[i].tdData.length;j++){
                    let tr=tr_data[i]
                    let td=tr_data[i].tdData[j];
                    td.diff=[];
                    var n=0
                    for(let k=0;k<team_data[i].length;k++){
                        let tmp=team_data[i][k];
                        // if(i==29&&j==28){
                        //     console.log(tmp)
                        // }
                        if(tmp.home==tr.state&&tmp.visitor==td.state)td.diff.push(tmp);
                        else if(tmp.home==td.state&&tmp.visitor==tr.state)td.diff.push(tmp);
                        else continue;
                    }
                }
            }











            var th=d3.select('.head tr')
                .selectAll('.th_not_first')
                .data(th_data)
                .enter()
                .append('th')
                .attr('class','th_not_first')
                .append('p')
                .text(function (d) {
                    return d.state;
                })
        var tr=d3.select('table tbody')
                .selectAll('tr')
                .data(tr_data)
                .enter()
                .append('tr');
        var td_first=tr.append('td').attr('class','td_first');
        var td_not_first=tr.selectAll('.td_not_first')
                .data(function (d) {
                    return d.tdData;
                })
                .enter()
                .append('td')
                .attr('class','td_not_first');

        var td1_width=$('.td_first').eq(0).width();//首个td的宽度 较长
        var tdn_width=tdn_height=td1_height=$('.td_not_first').eq(0).width();//后面td的宽度、高度和首个td的高度一致
        var svg_1=td_first.append('svg')
                            .attr('height',td1_height)
                            .attr('width',td1_width);
        var win_lost_scale=d3.scaleLinear()
                            .domain([0,82])
                            .range([0,td1_width]);
        svg_1.append('rect')
                .attr('height',td1_height)
                .attr('width',function (d) {
                    return win_lost_scale(d.totalWin);
                })
                .attr('fill','#71C671');
        svg_1.append('rect')
                .attr('height',td1_height)
                .attr('width',function (d) {
                    return td1_width-win_lost_scale(d.totalWin);
                })
                .attr('x',function (d) {
                    return win_lost_scale(d.totalWin);
                })
                .attr('fill','#FF3030');
        var text=svg_1.append('text')
            .text(function (d) {
                return d.totalWin+'-'+d.totalLost+'   '+d.Name;
            })
            .style('font-size',td1_height/2)
            .attr('dy',3*td1_height/4)

        var svg_n=td_not_first.append('svg')
                            .attr('height',tdn_width)
                            .attr('width',tdn_width);
        svg_n.append('rect')
            .attr('height',tdn_width)
            .attr('width',tdn_width)
            .style('fill','white')
            .style('stroke','black');






        })
    })

</script>
<script type="text/javascript">
// 数据排序
    var data=[[
        'A',
        '1',
        '2',
        '3'
    ],[
        'B',
        '4',
        '5',
        '6'
    ],[
        'C',
        '7',
        '8',
        '9'
    ]];
    var tr=d3.select('table.test')
        .selectAll('tr')
        .data(data)
        .enter()
        .append('tr')
    var td=tr.selectAll('td')
                .data(function (d,i) {
                    return d;
                })
                .enter()
                .append('td')
                .text(function (d) {
                    return d;
                })
    // 行排序
    tr.sort(function (a,b) {
        return b[1]-a[1]
    }).order().selectAll('td')
        .text(function (d) {
            return d;
        })
    // 列排序
    td.sort(function (a,b) {
        return b-a
    }).text(function (d) {
        return d;
    })
</script>
</body>
</html>